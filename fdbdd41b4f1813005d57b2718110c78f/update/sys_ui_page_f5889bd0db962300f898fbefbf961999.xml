<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_page">
    <sys_ui_page action="INSERT_OR_UPDATE">
        <category>general</category>
        <client_script><![CDATA[/* eslint "no-param-reassign": ["error", { "props": true, "ignorePropertyModificationsFor": ["el"] }] */
/* global myOnChange:readonly */
/* exported onCancel, onNext, checkAmountChanged */

// hack instantiate glideform so form message functionality works
// not all g_form functionality works (e.g., setFieldMsg)
// requires hidden field with id of dummy_table_name.do to avoid
// exception firing an event on page load
var g_form = new GlideForm("x_89907_vehicle_to_payment");


gel('button.date_received').setAttribute( "data-date_time_format" , g_user_date_format );
gel('button.date_of_check').setAttribute( "data-date_time_format" , g_user_date_format );


function onCancel() {
	var c = gel("cancelled");
	c.value = "true";

	// not in dialog - let processing script redirect
	return true;
}

function onNext() {
	g_form.clearMessages();
	if (!validateForm()) {
		return false;
	}
	return true;
}

function validateForm() {
	if (
		!validateUserField() ||
		!validateDateReceived() ||
		!validateDateOfCheck() ||
		!validateCheckAmount() ||
		!validateCheckNumber()
	) {
		return false;
	}
	return true;
}

function validateUserField() {
	var value = gel("user_name").value;
	if (value == "" || value == undefined || value == null) {
		g_form.addErrorMessage("User name is required.");
		return false;
	}
	return true;
}

function validateDateReceived() {
	var value = gel("date_received").value;
	if (value == "" || value == undefined || value == null) {
		g_form.addErrorMessage("Date received is required.");
		return false;
	} else if (!isValidDate(value)) {
		g_form.addErrorMessage(
			"Date received is not a valid date or not in the expected format."
		);
		return false;
	}
	return true;
}

function validateDateOfCheck() {
	var value = gel("date_of_check").value;
	if (value == "" || value == undefined || value == null) {
		return true;
	} else if (!isValidDate(value)) {
		g_form.addErrorMessage(
			"Date of check is not a valid date or not in the expected format."
		);
		return false;
	}
	return true;
}

function validateCheckAmount() {
	var value = gel("check_amount").value;
	if (value == "" || value == undefined || value == null) {
		g_form.addErrorMessage("Check amount is required.");
		return false;
	} else if (!isValidDecimal(value)) {
		g_form.addErrorMessage(
			"Invalid check amount."
		);
		return false;
	}
	return true;
}

function validateCheckNumber() {
	var value = gel("check_number").value;
	if ( !/^\d{1,40}$/.test(value) ) {
		g_form.addErrorMessage(
			"Invalid check number."
		);
		return false;
	}
	return true;
}

function isValidDecimal(value) {
	var valueFloat = parseFloat(value);
	if (isNaN(valueFloat) || !isFinite(valueFloat)) {
		return false;
	}
	return true;
}

function isValidDate(value) {
	if (value == "" || value == undefined || value == null) {
		return false;
	}
	return getDateFromFormat(value, g_user_date_format) != 0;
}

function checkAmountChanged(el) {
	g_form.clearMessages();
	var input = formatClean(el.value);
	var formatted = formatNumber(input);
	if (input == "" && el.value != "") {
		g_form.addErrorMessage("Invalid check amount.");
		return;
	} else if (formatted == "0" && input != "0") {
		g_form.addErrorMessage("Invalid check amount.");
		return;
	}
	var checkAmountFloat = parseFloat(input);
	if (isNaN(checkAmountFloat) || !isFinite(checkAmountFloat)) {
		g_form.addErrorMessage("Invalid check amount.");
	} else {
		el.value = checkAmountFloat.toFixed(2);
	}

	onChange("check_amount");
// 	myOnChange("check_amount", el.value);
}

function checkNumberChanged(el) {
	g_form.clearMessages();
	if ( !/^\d{1,40}$/.test(el.value) ) {
		g_form.addErrorMessage("Invalid check number.");
		return;
	}
	onChange("check_number");
// 	myOnChange("check_number", el.value);
}
]]></client_script>
        <description>UI Page to collect basic information for creating a new payment record; used by financial coordinator upon receipt of payment from user&#13;
Next button flows to page to select user statement records associated with payment</description>
        <direct>false</direct>
        <endpoint>x_89907_vehicle_to_new_payment.do</endpoint>
        <html><![CDATA[<?xml version="1.0" encoding="utf-8" ?>
<j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null">
	<j:set var="jvar_isDialog_parm" value="${sysparm_isdialog}"/>

	<g:evaluate var="jvar_isMobile">
		var myIsMobile = gs.isMobile();
		myIsMobile
	</g:evaluate>

	<g:evaluate var="jvar_userFilter">
		function getUserIDs() {
			var users = {};
			var statementsGrAgg = new GlideAggregate('x_89907_vehicle_to_toll_user_statement');
			statementsGrAgg.addQuery('status', '1');
			statementsGrAgg.addQuery('progress_phase', '2');
			statementsGrAgg.groupBy('user');
			statementsGrAgg.query();   
			while (statementsGrAgg.next()) {  
				users[statementsGrAgg.user.toString()] = true;
			}
			var ids = [];
			for (var id in users) {
				ids.push(id);
			}
			return ids;
		}

		var userFilter = "sys_idIN" + getUserIDs().join(",");
		userFilter
	</g:evaluate>

	<g:evaluate var="jvar_paymentGR">
		// paymentGR.getElement("number").getLabel()
		var paymentGR = new GlideRecord('x_89907_vehicle_to_payment');
		paymentGR
	</g:evaluate>


	<g:evaluate var="jvar_isDialog" jelly="true">
		(jelly.jvar_isDialog_parm) ? jelly.jvar_isDialog_parm : false
	</g:evaluate>

	<g:macro_invoke macro="x_89907_vehicle_to_payment_process_flow" stage="1" />



	<div class="container">
		<div class="row">
			<div class="col-lg-3 col-sm-1">$[SP]</div>
			<div class="col-lg-6 col-sm-10 page-header">Enter information for the payment</div>
			<div class="col-lg-3 col-sm-1">$[SP]</div>
		</div>
		<div class="row">
			<div class="col-lg-3 col-sm-1"></div>
			<div class="col-lg-6 col-sm-10">

				<g:ui_form form_class="form-horizontal">
					<!-- Create dummy field element so fire function doesnt bomb because there's no element named xxx.do -->
					<input type="hidden" id="x_89907_vehicle_to_payment.do" name="x_89907_vehicle_to_payment" value="x_89907_vehicle_to_payment" />
					<input type="hidden" name="hidden_isMobile" id="hidden_isMobile" value="${jvar_isMobile}"/>
					<input type="hidden" name="hidden_isDialog" id="hidden_isDialog" value="${jvar_isDialog}"/>
					<input type="hidden" name="cancelled" id="cancelled" value="false"/>

					<div class="row">
						<div id="element.user_name" class="form-group is-required">
							<div id="label.user_name" class="col-xs-12 col-md-3 col-lg-4 text-right">
								<g:form_label for="user_name">${paymentGR.getElement("user").getLabel()}</g:form_label>
							</div>
							<div class="col-xs-12 col-md-9 col-lg-8  form-field input_controls ">
								<g2:ui_reference name="user_name" id="user" table="sys_user" query="${jvar_userFilter}" completer="AJAXTableCompleter" columns="email"/>
							</div>
						</div>
						<div id="element.check_number" class="form-group">
							<div id="label.check_number" class="col-xs-12 col-md-3 col-lg-4 text-right">
								<g:form_label for="check_number">${paymentGR.getElement("check_number").getLabel()}</g:form_label>
							</div>
							<div class="col-xs-12 col-md-9 col-lg-8 form-field input_controls">
								<input type="text" id="check_number" name="check_number" class="form-control" maxlength="40" value="" onclick="select();" onchange="return checkNumberChanged(this);"/>
							</div>
						</div>
						<div id="element.check_amount" class="form-group is-required">
							<div id="label.check_amount" class="col-xs-12 col-md-3 col-lg-4 text-right">
								<g:form_label for="check_amount">${paymentGR.getElement("check_amount").getLabel()}</g:form_label>
							</div>
							<div class="col-xs-12 col-md-9 col-lg-8 form-field input_controls">
								<div class="input-group">
									<span class="input-group-addon">
										<span style="position: relative; display: inline-block;">
											<label class="" for="x_89907_vehicle_to_payment.check_amount.currency_type">$</label>
										</span>
									</span>
									<input type="text" id="check_amount" name="check_amount" class="decimal form-control" maxlength="14" value="" onclick="select();" onchange="return checkAmountChanged(this);"/>
								</div>
							</div>
						</div>
						<div id="element.date_of_check" class="form-group">
							<div id="label.date_of_check" class="col-xs-12 col-md-3 col-lg-4 text-right">
								<label for="date_of_check" dir="ltr" class="  control-label">
									<span id="status.date_of_check" mandatory="" oclass="" class="required-marker"></span>
									<span class="label-text" data-html="false">${paymentGR.getElement("date_of_check").getLabel()}</span>
								</label>
							</div>
							<div class="col-xs-12 col-md-9 col-lg-8 form-field input_controls ">
								<label for="date_of_check" style="display:none">date_of_check</label>
								<span class="input-group ">
									<input class="form-control text-align-right-ltr" id="date_of_check" type="text" name="date_of_check" value=""/>
									<span class="input-group-btn">
										<button class="btn btn-default btn-ref" name="button.date_of_check" id="button.date_of_check" tabindex="-1" title="Select date and time" aria-label="Select date and time" data-original-title="Select date and time" onclick="new GwtDateTimePicker('date_of_check', g_user_date_format, false);" type="button">
											<span class="icon-calendar icon" aria-hidden="true"></span>
										</button>
									</span>
								</span>
							</div>
						</div>
						<div id="element.date_received" class="form-group is-required">
							<div id="label.date_received" class="col-xs-12 col-md-3 col-lg-4 text-right">
								<label for="date_received" dir="ltr" class="  control-label">
									<span id="status.date_received" mandatory="true" oclass="" class="required-marker"></span>
									<span class="label-text" data-html="false">${paymentGR.getElement("date_received").getLabel()}</span>
								</label>
							</div>
							<div class="col-xs-12 col-md-9 col-lg-8 form-field input_controls ">
								<label for="date_received" style="display:none">date_received</label>
								<span class="input-group ">
									<input class="form-control text-align-right-ltr" id="date_received" type="text" name="date_received" value=""/>
									<span class="input-group-btn">
										<button class="btn btn-default btn-ref" name="button.date_received" id="button.date_received" tabindex="-1" title="Select date and time" aria-label="Select date and time"  data-original-title="Select date and time" onclick="new GwtDateTimePicker('date_received', g_user_date_format, false);" type="button">
											<span class="icon-calendar icon" aria-hidden="true"></span>
										</button>
									</span>
								</span>
							</div>
						</div>
					</div>
					<div class="row">
						<span style="float:right;padding-top:5px;">
							<g:dialog_buttons_ok_cancel ok="return onNext();" ok_id="next_button" ok_type="submit" ok_text="Next" cancel="return onCancel();" cancel_id="cancel_button" cancel_type="submit" cancel_text="${gs.getMessage('Cancel')}" />
						</span>
					</div>

				</g:ui_form>
			</div>
			<div class="col-lg-3 col-sm-1"></div>
		</div>
	</div>
</j:jelly>]]></html>
        <name>new_payment</name>
        <processing_script><![CDATA[/* globals user_name,hidden_isDialog,date_of_check,date_received,check_amount,check_number */
if (cancelled == "true") {
	response.sendRedirect(
		"x_89907_vehicle_to_payment_list.do?sysparm_userpref_module=aceced31db55e700f898fbefbf961915&sysparm_clear_stack=true"
	);
	gs.addInfoMessage("Creation of new payment cancelled.");
}

if (cancelled == "false") {
	var redirectURL = "x_89907_vehicle_to_submit_payment.do?";
	response.sendRedirect(
		redirectURL.concat(
			"sysparm_user_statement_user=",
			user_name,
			"&sysparm_dialog=",
			hidden_isDialog,
			"&sysparm_date_of_check=",
			date_of_check,
			"&sysparm_date_received=",
			date_received,
			"&sysparm_check_amount=",
			check_amount,
			"&sysparm_check_number=",
			check_number
		)
	);
}
]]></processing_script>
        <sys_class_name>sys_ui_page</sys_class_name>
        <sys_created_by>chad.hall</sys_created_by>
        <sys_created_on>2018-12-07 01:21:56</sys_created_on>
        <sys_id>f5889bd0db962300f898fbefbf961999</sys_id>
        <sys_mod_count>134</sys_mod_count>
        <sys_name>new_payment</sys_name>
        <sys_package display_value="Vehicle Tolls" source="x_89907_vehicle_to">fdbdd41b4f1813005d57b2718110c78f</sys_package>
        <sys_policy/>
        <sys_scope display_value="Vehicle Tolls">fdbdd41b4f1813005d57b2718110c78f</sys_scope>
        <sys_update_name>sys_ui_page_f5889bd0db962300f898fbefbf961999</sys_update_name>
        <sys_updated_by>SN_CHall</sys_updated_by>
        <sys_updated_on>2020-09-16 05:27:47</sys_updated_on>
    </sys_ui_page>
</record_update>
